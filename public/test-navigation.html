<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Navigation Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .result {
        margin: 10px 0;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 3px;
      }
      .success {
        background: #d4edda;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      button {
        padding: 10px 15px;
        margin: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>üß™ Priority-Based Navigation System Test</h1>

    <div class="test-section">
      <h3>Test 1: Debug User Role</h3>
      <button onclick="testUserRole()">Test User Role Debug</button>
      <div id="userRoleResult" class="result"></div>
    </div>

    <div class="test-section">
      <h3>Test 2: Current User Check</h3>
      <button onclick="testCurrentUser()">Test Current User</button>
      <div id="currentUserResult" class="result"></div>
    </div>

    <div class="test-section">
      <h3>Test 3: Navigation Logic</h3>
      <button onclick="testNavigationLogic()">Test Priority Navigation</button>
      <div id="navigationResult" class="result"></div>
    </div>

    <div class="test-section">
      <h3>Test 4: Manual Login</h3>
      <form onsubmit="testLogin(event)">
        <input
          type="email"
          id="email"
          placeholder="Email"
          value="ercanyter@gmail.com"
          required
        />
        <input type="password" id="password" placeholder="Password" required />
        <button type="submit">Test Login & Redirect</button>
      </form>
      <div id="loginResult" class="result"></div>
    </div>

    <script>
      // Test 1: Debug user role
      async function testUserRole() {
        const resultDiv = document.getElementById("userRoleResult");
        try {
          const response = await fetch("/api/debug/check-user-role");
          const data = await response.json();

          if (data.success) {
            resultDiv.className = "result success";
            resultDiv.innerHTML = `
                        <strong>‚úÖ SUCCESS</strong><br>
                        <strong>User:</strong> ${data.user.name} (${
              data.user.email
            })<br>
                        <strong>Role:</strong> ${
                          data.role.displayName
                        } (Priority: ${data.role.priority})<br>
                        <strong>Expected Dashboard:</strong> ${
                          data.analysis.expectedDashboard
                        }<br>
                        <strong>Should Go To Admin:</strong> ${
                          data.analysis.shouldGoToAdmin ? "YES" : "NO"
                        }<br>
                        <strong>Permissions:</strong> ${
                          data.permissions.length
                        } permissions
                    `;
          } else {
            resultDiv.className = "result error";
            resultDiv.innerHTML = `<strong>‚ùå ERROR:</strong> ${data.error}`;
          }
        } catch (error) {
          resultDiv.className = "result error";
          resultDiv.innerHTML = `<strong>‚ùå ERROR:</strong> ${error.message}`;
        }
      }

      // Test 2: Current user
      async function testCurrentUser() {
        const resultDiv = document.getElementById("currentUserResult");
        try {
          const response = await fetch("/api/auth/current-user", {
            credentials: "include",
          });
          const data = await response.json();

          if (response.ok && data.id) {
            resultDiv.className = "result success";
            resultDiv.innerHTML = `
                        <strong>‚úÖ LOGGED IN</strong><br>
                        <strong>User:</strong> ${data.name} (${data.email})<br>
                        <strong>Role ID:</strong> ${
                          data.roleId || "No role"
                        }<br>
                        <strong>Permissions:</strong> ${
                          data.permissions?.length || 0
                        } permissions
                    `;
          } else {
            resultDiv.className = "result error";
            resultDiv.innerHTML = `<strong>‚ùå NOT LOGGED IN:</strong> ${
              data.error || "Unauthorized"
            }`;
          }
        } catch (error) {
          resultDiv.className = "result error";
          resultDiv.innerHTML = `<strong>‚ùå ERROR:</strong> ${error.message}`;
        }
      }

      // Test 3: Navigation logic
      async function testNavigationLogic() {
        const resultDiv = document.getElementById("navigationResult");
        try {
          const userRoleResponse = await fetch("/api/debug/check-user-role");
          const userData = await userRoleResponse.json();

          if (!userData.success) {
            throw new Error("User data not available");
          }

          // Simulate login logic
          const hasAdminPermission =
            userData.permissions.includes("dashboard.admin");
          const hasHighPriorityRole = userData.role.priority >= 700;
          const expectedDashboard =
            hasAdminPermission || hasHighPriorityRole
              ? "/admin/dashboard"
              : "/users/dashboard";

          resultDiv.className = "result success";
          resultDiv.innerHTML = `
                    <strong>‚úÖ NAVIGATION LOGIC TEST</strong><br>
                    <strong>Has Admin Permission:</strong> ${
                      hasAdminPermission ? "YES" : "NO"
                    }<br>
                    <strong>Has High Priority Role:</strong> ${
                      hasHighPriorityRole ? "YES" : "NO"
                    } (Priority: ${userData.role.priority})<br>
                    <strong>Expected Redirect:</strong> <strong style="color: #0066cc;">${expectedDashboard}</strong><br>
                    <strong>Analysis Match:</strong> ${
                      expectedDashboard === userData.analysis.expectedDashboard
                        ? "‚úÖ MATCH"
                        : "‚ùå MISMATCH"
                    }
                `;
        } catch (error) {
          resultDiv.className = "result error";
          resultDiv.innerHTML = `<strong>‚ùå ERROR:</strong> ${error.message}`;
        }
      }

      // Test 4: Login test
      async function testLogin(event) {
        event.preventDefault();
        const resultDiv = document.getElementById("loginResult");
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        try {
          resultDiv.innerHTML = "‚è≥ Testing login...";

          const response = await fetch("/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
            credentials: "include",
          });

          const data = await response.json();

          if (data.success) {
            // Simulate the redirect logic from login page
            const hasAdminPermission =
              data.user.permissions?.includes("dashboard.admin");
            const hasHighPriorityRole = data.user.authContext?.userRoles?.some(
              (role) => role.priority >= 700
            );
            const dashboardUrl =
              hasAdminPermission || hasHighPriorityRole
                ? "/tr/admin/dashboard"
                : "/tr/users/dashboard";

            resultDiv.className = "result success";
            resultDiv.innerHTML = `
                        <strong>‚úÖ LOGIN SUCCESS</strong><br>
                        <strong>User:</strong> ${data.user.name}<br>
                        <strong>Admin Permission:</strong> ${
                          hasAdminPermission ? "YES" : "NO"
                        }<br>
                        <strong>High Priority Role:</strong> ${
                          hasHighPriorityRole ? "YES" : "NO"
                        }<br>
                        <strong>Redirect URL:</strong> <strong style="color: #0066cc;">${dashboardUrl}</strong><br>
                        <button onclick="window.location.href='${dashboardUrl}'" style="margin-top: 10px;">
                            üöÄ Go to Dashboard
                        </button>
                    `;
          } else {
            resultDiv.className = "result error";
            resultDiv.innerHTML = `<strong>‚ùå LOGIN FAILED:</strong> ${data.error}`;
          }
        } catch (error) {
          resultDiv.className = "result error";
          resultDiv.innerHTML = `<strong>‚ùå ERROR:</strong> ${error.message}`;
        }
      }

      // Auto-run tests on page load
      window.onload = function () {
        testUserRole();
        testCurrentUser();
        testNavigationLogic();
      };
    </script>
  </body>
</html>
